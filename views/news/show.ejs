<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= news.title %> | Khelkud Nepal</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
  <%- include('../partials/header') %>

<div class="container py-4">
  <div class="row">
    <div class="col-lg-8">
      <article class="mb-4">
        <h1 class="mb-3"><%= news.title %></h1>
        
        <div class="mb-3 text-muted">
          <small>
            <i class="bi bi-calendar"></i> <%= new Date(news.publishedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
            <% if(news.author) { %>
              <span class="ms-3"><i class="bi bi-person"></i> <%= news.author %></span>
            <% } %>
            <span class="ms-3"><i class="bi bi-eye"></i> <%= news.views || 0 %> views</span>
          </small>
        </div>
        
        <div class="mb-4">
          <% if (news.images && news.images.length > 1) { %>
            <!-- Image Carousel for multiple images -->
            <div id="newsImageCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
              <div class="carousel-indicators">
                <% news.images.forEach((img, index) => { %>
                  <button type="button" data-bs-target="#newsImageCarousel" data-bs-slide-to="<%= index %>" 
                    class="<%= index === 0 ? 'active' : '' %>" aria-current="<%= index === 0 ? 'true' : 'false' %>" 
                    aria-label="Slide <%= index + 1 %>"></button>
                <% }); %>
              </div>
              <div class="carousel-inner">
                <% news.images.forEach((img, index) => { %>
                  <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                    <img src="<%= img %>" class="d-block w-100 article-image rounded" 
                      alt="<%= news.title %> - image <%= index + 1 %>"
                      onerror="this.onerror=null; this.src='/images/placeholder.jpg';">
                  </div>
                <% }); %>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#newsImageCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#newsImageCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
              </button>
            </div>
          <% } else { %>
            <!-- Single image display (for backward compatibility) -->
            <img src="<%= news.imageUrl %>" class="img-fluid rounded mb-4 w-100 article-image" 
              alt="<%= news.title %>" onerror="this.onerror=null; this.src='/images/placeholder.jpg';">
          <% } %>
        </div>
        
        <div class="article-content mb-4">
          <% if (news.content) { %>
            <% news.content.split('\n\n').forEach(paragraph => { %>
              <p><%= paragraph %></p>
            <% }); %>
          <% } else { %>
            <p><%= news.summary %></p>
          <% } %>
        </div>
        
        <!-- Image Gallery (Thumbnail View) -->
        <% if (news.images && news.images.length > 2) { %>
          <div class="image-gallery mt-4 mb-5">
            <h5>Image Gallery</h5>
            <div class="row g-2 mt-2">
              <% news.images.forEach((img, index) => { %>
                <div class="col-4 col-md-3">
                  <a href="<%= img %>" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-index="<%= index %>">
                    <img src="<%= img %>" class="img-fluid thumbnail rounded" 
                      alt="<%= news.title %> - thumbnail <%= index + 1 %>"
                      onerror="this.onerror=null; this.src='/images/placeholder.jpg';">
                  </a>
                </div>
              <% }); %>
            </div>
          </div>
          
          <!-- Image Modal for fullscreen viewing -->
          <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="imageModalLabel"><%= news.title %></h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <img id="modalImage" src="" class="img-fluid w-100" alt="Full size image">
                </div>
              </div>
            </div>
          </div>
        <% } %>
        
        <% if (news.tags && news.tags.length > 0) { %>
          <div class="mb-3">
            <% news.tags.forEach(tag => { %>
              <a href="/search?q=<%= tag %>" class="badge bg-secondary text-decoration-none me-1"><%= tag %></a>
            <% }); %>
          </div>
        <% } %>
        
        <div class="d-flex justify-content-between align-items-center mt-4">
          <a href="/" class="btn btn-outline-primary"><i class="bi bi-arrow-left me-2"></i>Back to Home</a>
          <div>
            <button class="btn btn-outline-primary share-btn" data-share-url="<%= `${process.env.BASE_URL || ''}/news/${news._id}` %>" data-share-title="<%= news.title %>">
              <i class="bi bi-share me-1"></i> Share
            </button>
          </div>
        </div>
      </article>
      
      <div class="comments-section mt-5">
        <h3 class="section-title">Comments</h3>
        <div class="card">
          <div class="card-body">
            <% if (locals.user) { %>
              <form id="comment-form" class="mb-4">
                <div class="mb-3">
                  <textarea class="form-control" id="comment-content" rows="3" placeholder="Write your comment here..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Post Comment</button>
              </form>
              <hr>
              <div id="comments-container">
                <div class="text-center py-3">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading comments...</span>
                  </div>
                </div>
              </div>
            <% } else { %>
              <p class="text-center">
                <a href="/login" class="btn btn-outline-primary">Login</a> or 
                <a href="/register" class="btn btn-outline-secondary">Register</a> 
                to post comments
              </p>
              <hr>
              <div id="comments-container">
                <div class="text-center py-3">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading comments...</span>
                  </div>
                </div>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">Related News</h5>
        </div>
        <div class="card-body">
          <div id="related-news-container">
            <div class="text-center">
              <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
              <p class="mt-2 small">Loading related articles...</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="card-title mb-0">Latest in <%= news.category || 'Sports' %></h5>
        </div>
        <div class="card-body">
          <div id="category-news-container">
            <div class="text-center">
              <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
              <p class="mt-2 small">Loading latest articles...</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar-section">
        <h4 class="sidebar-title">Popular Categories</h4>
        <div class="list-group list-group-flush">
          <a href="/category/football" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            Football
            <span class="badge bg-primary rounded-pill">14</span>
          </a>
          <a href="/category/cricket" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            Cricket
            <span class="badge bg-primary rounded-pill">12</span>
          </a>
          <a href="/category/basketball" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            Basketball
            <span class="badge bg-primary rounded-pill">8</span>
          </a>
          <a href="/category/athletics" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            Athletics
            <span class="badge bg-primary rounded-pill">6</span>
          </a>
          <a href="/category/tennis" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            Tennis
            <span class="badge bg-primary rounded-pill">5</span>
          </a>
        </div>
      </div>
      
      <div class="sidebar-section">
        <h4 class="sidebar-title">Newsletter</h4>
        <p>Subscribe to our newsletter to receive the latest updates.</p>
        <form id="sidebar-subscription-form">
          <div class="mb-3">
            <input type="email" class="form-control" placeholder="Your email address" required>
          </div>
          <button type="submit" class="btn btn-primary w-100">Subscribe</button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  .article-image {
    max-height: 500px;
    object-fit: cover;
  }
  
  .image-gallery .thumbnail {
    height: 100px;
    object-fit: cover;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .image-gallery .thumbnail:hover {
    opacity: 0.8;
    transform: scale(1.05);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Load related news
    fetch(`/api/news/related/<%= news._id %>`)
      .then(response => response.json())
      .then(data => {
        const container = document.getElementById('related-news-container');
        if (data.success && data.data.length > 0) {
          container.innerHTML = '';
          data.data.forEach(item => {
            container.innerHTML += `
              <div class="mb-3">
                <div class="row g-0">
                  <div class="col-4">
                    <img src="${item.imageUrl || '/images/placeholder.jpg'}" class="img-fluid rounded" 
                         alt="${item.title}"
                         onerror="this.onerror=null; this.src='/images/placeholder.jpg';">
                  </div>
                  <div class="col-8 ps-2">
                    <h6 class="mb-1" style="font-size: 0.9rem;">${item.title}</h6>
                    <a href="/news/${item._id}" class="btn btn-sm btn-link p-0">Read More</a>
                  </div>
                </div>
              </div>
            `;
          });
        } else {
          container.innerHTML = '<p class="text-center">No related news found.</p>';
        }
      })
      .catch(error => {
        console.error('Error loading related news:', error);
        document.getElementById('related-news-container').innerHTML = 
          '<p class="text-center text-danger">Error loading related news.</p>';
      });
    
    // Load category news
    fetch(`/api/news/category/<%= news.category %>?limit=5`)
      .then(response => response.json())
      .then(data => {
        const container = document.getElementById('category-news-container');
        if (data.success && data.data.length > 0) {
          container.innerHTML = '';
          data.data.forEach(item => {
            // Skip the current article
            if (item._id === '<%= news._id %>') return;
            
            container.innerHTML += `
              <div class="mb-3">
                <div class="row g-0">
                  <div class="col-4">
                    <img src="${item.imageUrl || '/images/placeholder.jpg'}" class="img-fluid rounded" 
                         alt="${item.title}"
                         onerror="this.onerror=null; this.src='/images/placeholder.jpg';">
                  </div>
                  <div class="col-8 ps-2">
                    <h6 class="mb-1" style="font-size: 0.9rem;">${item.title}</h6>
                    <a href="/news/${item._id}" class="btn btn-sm btn-link p-0">Read More</a>
                  </div>
                </div>
              </div>
            `;
          });
        } else {
          container.innerHTML = '<p class="text-center">No category news found.</p>';
        }
      })
      .catch(error => {
        console.error('Error loading category news:', error);
        document.getElementById('category-news-container').innerHTML = 
          '<p class="text-center text-danger">Error loading category news.</p>';
      });
    
    // Handle image modal
    const imageModal = document.getElementById('imageModal');
    if (imageModal) {
      imageModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const imageUrl = button.querySelector('img').src;
        const modalImage = document.getElementById('modalImage');
        modalImage.src = imageUrl;
      });
    }
    
    // Share functionality
    document.querySelectorAll('.share-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const url = this.getAttribute('data-share-url');
        const title = this.getAttribute('data-share-title');
        
        if (navigator.share) {
          navigator.share({
            title: title,
            url: url
          }).catch(console.error);
        } else {
          // Fallback for browsers that don't support Web Share API
          navigator.clipboard.writeText(url).then(() => {
            // Show a small toast or alert that the URL was copied
            alert('Link copied to clipboard!');
          }).catch(err => {
            console.error('Could not copy text: ', err);
          });
        }
      });
    });
  });
  
  // Load comments
  document.addEventListener('DOMContentLoaded', function() {
    // Load comments for this news article
    const newsId = '<%= news._id %>';
    loadComments(newsId);
    
    // Handle comment form submission if user is logged in
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
      commentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const content = document.getElementById('comment-content').value;
        
        if (!content.trim()) {
          alert('Please enter a comment');
          return;
        }
        
        // Submit comment
        fetch(`/api/comments/news/${newsId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            content
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Clear form and reload comments
            document.getElementById('comment-content').value = '';
            loadComments(newsId);
          } else {
            alert(data.message || 'There was an error posting your comment. Please try again.');
          }
        })
        .catch(error => {
          console.error('Error posting comment:', error);
          alert('There was an error posting your comment. Please try again.');
        });
      });
    }
  });
  
  // Function to load comments
  function loadComments(newsId) {
    fetch(`/api/comments/news/${newsId}`)
      .then(response => response.json())
      .then(data => {
        const commentsContainer = document.getElementById('comments-container');
        
        if (data.success) {
          if (data.count > 0) {
            commentsContainer.innerHTML = '';
            
            data.data.forEach(comment => {
              // Format date
              const commentDate = new Date(comment.createdAt);
              const formattedDate = commentDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
              
              // Create HTML for comment
              const html = `
                <div class="comment mb-3">
                  <div class="comment-header d-flex justify-content-between mb-2">
                    <div class="comment-author">
                      <strong>${comment.user.name || comment.user.username}</strong>
                    </div>
                    <div class="comment-date text-muted small">
                      ${formattedDate}
                    </div>
                  </div>
                  <div class="comment-body">
                    <p class="mb-0">${comment.content}</p>
                  </div>
                  ${comment.user._id === '<%= locals.user && locals.user.id %>' ? 
                    `<div class="comment-actions mt-2 text-end">
                      <button class="btn btn-sm btn-outline-danger delete-comment" data-id="${comment._id}">Delete</button>
                    </div>` : ''}
                </div>
              `;
              
              commentsContainer.innerHTML += html;
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-comment').forEach(btn => {
              btn.addEventListener('click', function() {
                const commentId = this.dataset.id;
                
                if (confirm('Are you sure you want to delete this comment?')) {
                  fetch(`/api/comments/${commentId}`, {
                    method: 'DELETE'
                  })
                  .then(response => response.json())
                  .then(data => {
                    if (data.success) {
                      loadComments(newsId);
                    } else {
                      alert(data.message || 'There was an error deleting your comment.');
                    }
                  })
                  .catch(error => {
                    console.error('Error deleting comment:', error);
                    alert('There was an error deleting your comment.');
                  });
                }
              });
            });
          } else {
            commentsContainer.innerHTML = '<p class="text-center text-muted">No comments yet. Be the first to comment!</p>';
          }
        } else {
          commentsContainer.innerHTML = '<p class="text-center text-muted">Could not load comments.</p>';
        }
      })
      .catch(error => {
        console.error('Error loading comments:', error);
        document.getElementById('comments-container').innerHTML = 
          '<p class="text-center text-muted">Error loading comments. Please try again later.</p>';
      });
  }
</script>

  <%- include('../partials/footer') %>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/main.js"></script>
</body>
</html> 