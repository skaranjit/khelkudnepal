<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Match Details - Khelkud Nepal</title>
  <link rel="stylesheet" href="/css/admin.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
  <%- include('../partials/header.ejs') %>

  <!-- Helper function to safely get team name -->
  <script>
    function getTeamName(team) {
      if (!team) return 'Unknown Team';
      if (typeof team === 'string') return team;
      if (typeof team === 'object' && team !== null) {
        if (team.name) return team.name;
        // If object is stringified, try to parse it
        if (typeof team.toString === 'function') {
          const teamStr = team.toString();
          const nameMatch = teamStr.match(/name:'?\s*([^,'"}]+)/i);
          if (nameMatch && nameMatch[1]) return nameMatch[1].trim();
        }
      }
      return 'Unknown Team';
    }
  </script>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <%- include('../partials/sidebar', { active: 'matches' }) %>

      <!-- Main content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Match Details</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <a href="/admin/matches" class="btn btn-sm btn-outline-secondary me-2">
              <i class="bi bi-arrow-left"></i> Back to Matches
            </a>
            <a href="/admin/matches/edit/<%= match._id %>" class="btn btn-sm btn-primary">
              <i class="bi bi-pencil"></i> Edit Match
            </a>
          </div>
        </div>

        <!-- Toast container for notifications -->
        <div class="toast-container position-fixed top-0 end-0 p-3">
          <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
              <strong class="me-auto" id="toast-title">Notification</strong>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
              Message placeholder
            </div>
          </div>
        </div>

        <% if (locals.messages && messages.success) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= messages.success %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        <% } %>

        <% if (locals.messages && messages.error) { %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <%= messages.error %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        <% } %>

        <!-- Match Overview Card -->
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header">
                <h5 class="card-title mb-0">Match Overview</h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-8">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded mb-4">
                      <div class="text-center">
                        <h4>
                          <%= typeof match.homeTeam === 'object' && match.homeTeam.name ? match.homeTeam.name : (typeof match.homeTeam === 'string' ? match.homeTeam : 'Unknown Team') %>
                        </h4>
                        <% if (match.category.toLowerCase() === 'cricket' && match.score && match.score.home_detail) { %>
                          <h2 class="mb-0"><%= match.score.home_detail %></h2>
                          <% if (match.score.home_overs) { %>
                            <small>(<%= match.score.home_overs %> overs)</small>
                          <% } %>
                        <% } else if (match.category.toLowerCase() === 'cricket' && match.stats && match.stats.home) { %>
                          <h2 class="mb-0"><%= (match.stats.home.runs || match.stats.home.runsScored || 0) %>/<%= match.stats.home.wickets || 0 %></h2>
                          <% if (match.stats.home.overs) { %>
                            <small>(<%= match.stats.home.overs %> overs)</small>
                          <% } %>
                        <% } else { %>
                          <h2 class="mb-0"><%= match.homeScore || (match.score && match.score.home) || 0 %></h2>
                        <% } %>
                      </div>
                      <div class="text-center">
                        <span class="badge bg-<%= match.status === 'live' ? 'danger' : match.status === 'completed' ? 'success' : 'secondary' %> mb-2">
                          <%= match.status.toUpperCase() %>
                        </span>
                        <h5>VS</h5>
                      </div>
                      <div class="text-center">
                        <h4>
                          <%= typeof match.awayTeam === 'object' && match.awayTeam.name ? match.awayTeam.name : (typeof match.awayTeam === 'string' ? match.awayTeam : 'Unknown Team') %>
                        </h4>
                        <% if (match.category.toLowerCase() === 'cricket' && match.score && match.score.away_detail) { %>
                          <h2 class="mb-0"><%= match.score.away_detail %></h2>
                          <% if (match.score.away_overs) { %>
                            <small>(<%= match.score.away_overs %> overs)</small>
                          <% } %>
                        <% } else if (match.category.toLowerCase() === 'cricket' && match.stats && match.stats.away) { %>
                          <h2 class="mb-0"><%= (match.stats.away.runs || match.stats.away.runsScored || 0) %>/<%= match.stats.away.wickets || 0 %></h2>
                          <% if (match.stats.away.overs) { %>
                            <small>(<%= match.stats.away.overs %> overs)</small>
                          <% } %>
                        <% } else { %>
                          <h2 class="mb-0"><%= match.awayScore || (match.score && match.score.away) || 0 %></h2>
                        <% } %>
                      </div>
                    </div>
                    
                    <% if (match.category.toLowerCase() === 'cricket' && match.stats) { %>
                    <div class="card mb-4">
                      <div class="card-header">
                        <h5 class="card-title mb-0">Cricket Match Stats</h5>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-6">
                            <h6 class="fw-bold">
                              <%= typeof match.homeTeam === 'object' && match.homeTeam.name ? match.homeTeam.name : (typeof match.homeTeam === 'string' ? match.homeTeam : 'Home Team') %>
                            </h6>
                            <ul class="list-group">
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Runs:</span>
                                <span><%= match.stats.home.runs || match.stats.home.runsScored || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Wickets:</span>
                                <span><%= match.stats.home.wickets || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Overs:</span>
                                <span><%= match.stats.home.overs || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Run Rate:</span>
                                <span><%= match.stats.home.runRate || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Extras:</span>
                                <span><%= match.stats.home.extras || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Fours:</span>
                                <span><%= match.stats.home.fours || (match.stats.home.boundaries && match.stats.home.boundaries.fours) || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Sixes:</span>
                                <span><%= match.stats.home.sixes || (match.stats.home.boundaries && match.stats.home.boundaries.sixes) || 0 %></span>
                              </li>
                              <% if (match.stats.home.topScorer) { %>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Top Scorer:</span>
                                <span><%= match.stats.home.topScorer.name %> (<%= match.stats.home.topScorer.runs %>)</span>
                              </li>
                              <% } %>
                              <% if (match.stats.home.topBowler) { %>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Top Bowler:</span>
                                <span><%= match.stats.home.topBowler.name %> (<%= match.stats.home.topBowler.wickets %>/<%= match.stats.home.topBowler.runsConceded %>)</span>
                              </li>
                              <% } %>
                            </ul>
                          </div>
                          <div class="col-md-6">
                            <h6 class="fw-bold">
                              <%= typeof match.awayTeam === 'object' && match.awayTeam.name ? match.awayTeam.name : (typeof match.awayTeam === 'string' ? match.awayTeam : 'Away Team') %>
                            </h6>
                            <ul class="list-group">
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Runs:</span>
                                <span><%= match.stats.away.runs || match.stats.away.runsScored || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Wickets:</span>
                                <span><%= match.stats.away.wickets || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Overs:</span>
                                <span><%= match.stats.away.overs || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Run Rate:</span>
                                <span><%= match.stats.away.runRate || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Extras:</span>
                                <span><%= match.stats.away.extras || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Fours:</span>
                                <span><%= match.stats.away.fours || (match.stats.away.boundaries && match.stats.away.boundaries.fours) || 0 %></span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Sixes:</span>
                                <span><%= match.stats.away.sixes || (match.stats.away.boundaries && match.stats.away.boundaries.sixes) || 0 %></span>
                              </li>
                              <% if (match.stats.away.topScorer) { %>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Top Scorer:</span>
                                <span><%= match.stats.away.topScorer.name %> (<%= match.stats.away.topScorer.runs %>)</span>
                              </li>
                              <% } %>
                              <% if (match.stats.away.topBowler) { %>
                              <li class="list-group-item d-flex justify-content-between">
                                <span>Top Bowler:</span>
                                <span><%= match.stats.away.topBowler.name %> (<%= match.stats.away.topBowler.wickets %>/<%= match.stats.away.topBowler.runsConceded %>)</span>
                              </li>
                              <% } %>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                    <% } %>
                    
                    <% if (match.category.toLowerCase() === 'football' && match.stats) { %>
                    <div class="card mb-4">
                      <div class="card-header">
                        <h5 class="card-title mb-0">Football Match Stats</h5>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-12">
                            <div class="table-responsive">
                              <table class="table table-bordered table-sm">
                                <thead>
                                  <tr>
                                    <th>Stat</th>
                                    <th class="text-center">
                                      <%= typeof match.homeTeam === 'object' && match.homeTeam.name ? match.homeTeam.name : (typeof match.homeTeam === 'string' ? match.homeTeam : 'Home') %>
                                    </th>
                                    <th class="text-center">
                                      <%= typeof match.awayTeam === 'object' && match.awayTeam.name ? match.awayTeam.name : (typeof match.awayTeam === 'string' ? match.awayTeam : 'Away') %>
                                    </th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr>
                                    <td>Score</td>
                                    <td class="text-center fw-bold"><%= match.homeScore || (match.score && match.score.home) || 0 %></td>
                                    <td class="text-center fw-bold"><%= match.awayScore || (match.score && match.score.away) || 0 %></td>
                                  </tr>
                                  <tr>
                                    <td>Possession</td>
                                    <td class="text-center"><%= match.stats.homePossession || (match.stats.home && match.stats.home.possession) || 0 %>%</td>
                                    <td class="text-center"><%= match.stats.awayPossession || (match.stats.away && match.stats.away.possession) || 0 %>%</td>
                                  </tr>
                                  <tr>
                                    <td>Shots</td>
                                    <td class="text-center"><%= match.stats.homeShots || (match.stats.home && (match.stats.home.shotsTotal || match.stats.home.shots)) || 0 %></td>
                                    <td class="text-center"><%= match.stats.awayShots || (match.stats.away && (match.stats.away.shotsTotal || match.stats.away.shots)) || 0 %></td>
                                  </tr>
                                  <tr>
                                    <td>Shots on Target</td>
                                    <td class="text-center"><%= match.stats.homeShotsOnTarget || (match.stats.home && match.stats.home.shotsOnTarget) || 0 %></td>
                                    <td class="text-center"><%= match.stats.awayShotsOnTarget || (match.stats.away && match.stats.away.shotsOnTarget) || 0 %></td>
                                  </tr>
                                  <tr>
                                    <td>Corners</td>
                                    <td class="text-center"><%= match.stats.homeCorners || (match.stats.home && match.stats.home.corners) || 0 %></td>
                                    <td class="text-center"><%= match.stats.awayCorners || (match.stats.away && match.stats.away.corners) || 0 %></td>
                                  </tr>
                                  <tr>
                                    <td>Yellow Cards</td>
                                    <td class="text-center"><%= match.stats.homeYellowCards || (match.stats.home && match.stats.home.yellowCards) || 0 %></td>
                                    <td class="text-center"><%= match.stats.awayYellowCards || (match.stats.away && match.stats.away.yellowCards) || 0 %></td>
                                  </tr>
                                  <tr>
                                    <td>Red Cards</td>
                                    <td class="text-center"><%= match.stats.homeRedCards || (match.stats.home && match.stats.home.redCards) || 0 %></td>
                                    <td class="text-center"><%= match.stats.awayRedCards || (match.stats.away && match.stats.away.redCards) || 0 %></td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <% } %>
                    
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <h6 class="fw-bold">Category:</h6>
                          <p><%= match.category.charAt(0).toUpperCase() + match.category.slice(1) %></p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <h6 class="fw-bold">Status:</h6>
                          <p>
                            <span class="badge bg-<%= match.status === 'live' ? 'danger' : match.status === 'completed' ? 'success' : match.status === 'postponed' ? 'warning' : match.status === 'cancelled' ? 'dark' : 'primary' %>">
                              <%= match.status.toUpperCase() %>
                            </span>
                          </p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <h6 class="fw-bold">Start Time:</h6>
                          <p><%= new Date(match.startTime).toLocaleString() %></p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <h6 class="fw-bold">End Time:</h6>
                          <p><%= match.endTime ? new Date(match.endTime).toLocaleString() : 'Not specified' %></p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <h6 class="fw-bold">Tournament:</h6>
                          <p><%= match.tournament || 'Not specified' %></p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <h6 class="fw-bold">Round/Stage:</h6>
                          <p><%= match.round || 'Not specified' %></p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <h6 class="fw-bold">Venue:</h6>
                          <p><%= match.venue && match.venue.name ? match.venue.name : 'Not specified' %></p>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <h6 class="fw-bold">Location:</h6>
                          <p><%= match.venue && match.venue.location ? match.venue.location : 'Not specified' %></p>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="col-md-4">
                    <% if (match.imageUrl) { %>
                      <img src="<%= match.imageUrl %>" alt="Match Image" class="img-fluid rounded mb-3">
                    <% } else { %>
                      <div class="bg-light d-flex justify-content-center align-items-center rounded mb-3" style="height: 200px;">
                        <span class="text-muted">No match image</span>
                      </div>
                    <% } %>
                    
                    <div class="d-grid gap-2">
                      <% if (match.status === 'live') { %>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#updateScoreModal">
                          <i class="bi bi-pencil-square"></i> Update Score
                        </button>
                      <% } %>
                      <a href="/admin/matches/edit/<%= match._id %>" class="btn btn-outline-primary">
                        <i class="bi bi-pencil"></i> Edit Match
                      </a>
                      <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteMatchModal">
                        <i class="bi bi-trash"></i> Delete Match
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Updates and Commentary Cards -->
        <div class="row mb-4">
          <!-- Match Updates -->
          <div class="col-lg-6 mb-4 mb-lg-0">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Match Updates</h5>
                <span class="badge bg-<%= match.status === 'live' ? 'success' : 'secondary' %>">
                  <%= match.status.toUpperCase() %>
                </span>
              </div>
              <div class="card-body">
                <% if (match.status === 'live') { %>
                  <form id="updateForm" class="mb-3">
                    <div class="input-group">
                      <input type="text" class="form-control" id="updateText" placeholder="Add match update..." required>
                      <div class="input-group-text">
                        <div class="form-check form-switch mb-0">
                          <input class="form-check-input" type="checkbox" id="updateImportantCheck">
                          <label class="form-check-label" for="updateImportantCheck">Key Event</label>
                        </div>
                      </div>
                      <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                  </form>
                <% } else { %>
                  <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Match updates are only available when the match is in progress.
                  </div>
                <% } %>
                
                <div class="updates-timeline">
                  <% if (match.updates && match.updates.length > 0) { %>
                    <div class="list-group">
                      <% match.updates.sort((a, b) => new Date(b.time) - new Date(a.time)).forEach(update => { %>
                        <div class="list-group-item list-group-item-action <%= update.important ? 'list-group-item-warning' : '' %>">
                          <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">
                              <% if (update.important) { %>
                                <span class="badge bg-warning text-dark me-2">Key Event</span>
                              <% } %>
                              <%= update.text %>
                            </h6>
                            <% if (match.status === 'live') { %>
                              <button class="btn btn-sm btn-outline-danger delete-update" data-update-id="<%= update._id %>">
                                <i class="bi bi-trash"></i>
                              </button>
                            <% } %>
                          </div>
                          <small class="text-muted"><%= new Date(update.time).toLocaleTimeString() %></small>
                        </div>
                      <% }) %>
                    </div>
                  <% } else { %>
                    <div class="text-center py-3">
                      <p class="text-muted mb-0">No updates added yet</p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Commentary -->
          <div class="col-lg-6">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Live Commentary</h5>
                <span class="badge bg-<%= match.status === 'live' ? 'success' : 'secondary' %>">
                  <%= match.status.toUpperCase() %>
                </span>
              </div>
              <div class="card-body">
                <% if (match.status === 'live') { %>
                  <form id="commentaryForm" class="mb-3">
                    <div class="input-group">
                      <input type="text" class="form-control" id="commentaryText" placeholder="Add commentary..." required>
                      <div class="input-group-text">
                        <div class="form-check form-switch mb-0">
                          <input class="form-check-input" type="checkbox" id="importantCheck">
                          <label class="form-check-label" for="importantCheck">Important</label>
                        </div>
                      </div>
                      <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                  </form>
                <% } else { %>
                  <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    Live commentary is only available when the match is in progress.
                  </div>
                <% } %>
                
                <div class="commentary-timeline">
                  <% if (match.commentary && match.commentary.length > 0) { %>
                    <div class="list-group">
                      <% match.commentary.sort((a, b) => new Date(b.time) - new Date(a.time)).forEach(comment => { %>
                        <div class="list-group-item list-group-item-action <%= comment.important ? 'list-group-item-warning' : '' %>">
                          <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">
                              <% if (comment.important) { %>
                                <span class="badge bg-warning text-dark me-2">Important</span>
                              <% } %>
                              <%= comment.text %>
                            </h6>
                            <% if (match.status === 'live') { %>
                              <button class="btn btn-sm btn-outline-danger delete-comment" data-comment-id="<%= comment._id %>">
                                <i class="bi bi-trash"></i>
                              </button>
                            <% } %>
                          </div>
                          <small class="text-muted"><%= new Date(comment.time).toLocaleTimeString() %></small>
                        </div>
                      <% }) %>
                    </div>
                  <% } else { %>
                    <div class="text-center py-3">
                      <p class="text-muted mb-0">No commentary added yet</p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Update Score Modal -->
        <div class="modal fade" id="updateScoreModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Update Score</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="scoreForm">
                  <% if (match.category.toLowerCase() === 'cricket') { %>
                    <div class="mb-3">
                      <h6 class="fw-bold">
                        <%= typeof match.homeTeam === 'object' && match.homeTeam.name ? match.homeTeam.name : (typeof match.homeTeam === 'string' ? match.homeTeam : 'Home Team') %>
                      </h6>
                      <div class="row g-2">
                        <div class="col-md-4">
                          <label for="homeRuns" class="form-label">Runs</label>
                          <input type="number" class="form-control" id="homeRuns" value="<%= match.stats?.home?.runs || match.stats?.home?.runsScored || 0 %>" min="0">
                        </div>
                        <div class="col-md-4">
                          <label for="homeWickets" class="form-label">Wickets</label>
                          <input type="number" class="form-control" id="homeWickets" value="<%= match.stats?.home?.wickets || 0 %>" min="0" max="10">
                        </div>
                        <div class="col-md-4">
                          <label for="homeOvers" class="form-label">Overs</label>
                          <input type="text" class="form-control" id="homeOvers" value="<%= match.stats?.home?.overs || '0.0' %>" placeholder="0.0">
                        </div>
                      </div>
                      <div class="row g-2 mt-2">
                        <div class="col-md-4">
                          <label for="homeRunRate" class="form-label">Run Rate</label>
                          <input type="number" class="form-control" id="homeRunRate" value="<%= match.stats?.home?.runRate || 0 %>" step="0.01" min="0">
                        </div>
                        <div class="col-md-4">
                          <label for="homeExtras" class="form-label">Extras</label>
                          <input type="number" class="form-control" id="homeExtras" value="<%= match.stats?.home?.extras || 0 %>" min="0">
                        </div>
                        <div class="col-md-4">
                          <label for="homeFours" class="form-label">Fours</label>
                          <input type="number" class="form-control" id="homeFours" value="<%= match.stats?.home?.fours || (match.stats?.home?.boundaries && match.stats.home.boundaries.fours) || 0 %>" min="0">
                        </div>
                      </div>
                      <div class="row g-2 mt-2">
                        <div class="col-md-4">
                          <label for="homeSixes" class="form-label">Sixes</label>
                          <input type="number" class="form-control" id="homeSixes" value="<%= match.stats?.home?.sixes || (match.stats?.home?.boundaries && match.stats.home.boundaries.sixes) || 0 %>" min="0">
                        </div>
                        <div class="col-md-8">
                          <label for="homeScoreDetail" class="form-label">Score Format</label>
                          <input type="text" class="form-control" id="homeScoreDetail" value="<%= match.score?.home_detail || `${match.stats?.home?.runs || match.stats?.home?.runsScored || 0}/${match.stats?.home?.wickets || 0}` %>" placeholder="0/0">
                        </div>
                      </div>
                    </div>
                    
                    <div class="mb-3 mt-4">
                      <h6 class="fw-bold">
                        <%= typeof match.awayTeam === 'object' && match.awayTeam.name ? match.awayTeam.name : (typeof match.awayTeam === 'string' ? match.awayTeam : 'Away Team') %>
                      </h6>
                      <div class="row g-2">
                        <div class="col-md-4">
                          <label for="awayRuns" class="form-label">Runs</label>
                          <input type="number" class="form-control" id="awayRuns" value="<%= match.stats?.away?.runs || match.stats?.away?.runsScored || 0 %>" min="0">
                        </div>
                        <div class="col-md-4">
                          <label for="awayWickets" class="form-label">Wickets</label>
                          <input type="number" class="form-control" id="awayWickets" value="<%= match.stats?.away?.wickets || 0 %>" min="0" max="10">
                        </div>
                        <div class="col-md-4">
                          <label for="awayOvers" class="form-label">Overs</label>
                          <input type="text" class="form-control" id="awayOvers" value="<%= match.stats?.away?.overs || '0.0' %>" placeholder="0.0">
                        </div>
                      </div>
                      <div class="row g-2 mt-2">
                        <div class="col-md-4">
                          <label for="awayRunRate" class="form-label">Run Rate</label>
                          <input type="number" class="form-control" id="awayRunRate" value="<%= match.stats?.away?.runRate || 0 %>" step="0.01" min="0">
                        </div>
                        <div class="col-md-4">
                          <label for="awayExtras" class="form-label">Extras</label>
                          <input type="number" class="form-control" id="awayExtras" value="<%= match.stats?.away?.extras || 0 %>" min="0">
                        </div>
                        <div class="col-md-4">
                          <label for="awayFours" class="form-label">Fours</label>
                          <input type="number" class="form-control" id="awayFours" value="<%= match.stats?.away?.fours || (match.stats?.away?.boundaries && match.stats.away.boundaries.fours) || 0 %>" min="0">
                        </div>
                      </div>
                      <div class="row g-2 mt-2">
                        <div class="col-md-4">
                          <label for="awaySixes" class="form-label">Sixes</label>
                          <input type="number" class="form-control" id="awaySixes" value="<%= match.stats?.away?.sixes || (match.stats?.away?.boundaries && match.stats.away.boundaries.sixes) || 0 %>" min="0">
                        </div>
                        <div class="col-md-8">
                          <label for="awayScoreDetail" class="form-label">Score Format</label>
                          <input type="text" class="form-control" id="awayScoreDetail" value="<%= match.score?.away_detail || `${match.stats?.away?.runs || match.stats?.away?.runsScored || 0}/${match.stats?.away?.wickets || 0}` %>" placeholder="0/0">
                        </div>
                      </div>
                    </div>
                  <% } else if (match.category.toLowerCase() === 'football') { %>
                    <div class="row mb-3">
                      <div class="col-6">
                        <label for="modalHomeScore" class="form-label">
                          <%= typeof match.homeTeam === 'object' && match.homeTeam.name ? match.homeTeam.name : (typeof match.homeTeam === 'string' ? match.homeTeam : 'Home Team') %> Score
                        </label>
                        <input type="number" class="form-control" id="modalHomeScore" value="<%= match.homeScore || (match.score && match.score.home) || 0 %>" min="0">
                      </div>
                      <div class="col-6">
                        <label for="modalAwayScore" class="form-label">
                          <%= typeof match.awayTeam === 'object' && match.awayTeam.name ? match.awayTeam.name : (typeof match.awayTeam === 'string' ? match.awayTeam : 'Away Team') %> Score
                        </label>
                        <input type="number" class="form-control" id="modalAwayScore" value="<%= match.awayScore || (match.score && match.score.away) || 0 %>" min="0">
                      </div>
                    </div>
                    
                    <h6 class="mt-4 mb-3">Football Match Statistics</h6>
                    
                    <div class="row mb-3">
                      <div class="col-6">
                        <label for="modalHomePossession" class="form-label">Home Possession (%)</label>
                        <input type="number" class="form-control" id="modalHomePossession" value="<%= match.stats?.homePossession || (match.stats?.home && match.stats.home.possession) || 50 %>" min="0" max="100">
                      </div>
                      <div class="col-6">
                        <label for="modalAwayPossession" class="form-label">Away Possession (%)</label>
                        <input type="number" class="form-control" id="modalAwayPossession" value="<%= match.stats?.awayPossession || (match.stats?.away && match.stats.away.possession) || 50 %>" min="0" max="100">
                      </div>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-6">
                        <label for="modalHomeShots" class="form-label">Home Shots</label>
                        <input type="number" class="form-control" id="modalHomeShots" value="<%= match.stats?.homeShots || (match.stats?.home && (match.stats.home.shotsTotal || match.stats.home.shots)) || 0 %>" min="0">
                      </div>
                      <div class="col-6">
                        <label for="modalAwayShots" class="form-label">Away Shots</label>
                        <input type="number" class="form-control" id="modalAwayShots" value="<%= match.stats?.awayShots || (match.stats?.away && (match.stats.away.shotsTotal || match.stats.away.shots)) || 0 %>" min="0">
                      </div>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-6">
                        <label for="modalHomeShotsOnTarget" class="form-label">Home Shots on Target</label>
                        <input type="number" class="form-control" id="modalHomeShotsOnTarget" value="<%= match.stats?.homeShotsOnTarget || (match.stats?.home && match.stats.home.shotsOnTarget) || 0 %>" min="0">
                      </div>
                      <div class="col-6">
                        <label for="modalAwayShotsOnTarget" class="form-label">Away Shots on Target</label>
                        <input type="number" class="form-control" id="modalAwayShotsOnTarget" value="<%= match.stats?.awayShotsOnTarget || (match.stats?.away && match.stats.away.shotsOnTarget) || 0 %>" min="0">
                      </div>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-6">
                        <label for="modalHomeCorners" class="form-label">Home Corners</label>
                        <input type="number" class="form-control" id="modalHomeCorners" value="<%= match.stats?.homeCorners || (match.stats?.home && match.stats.home.corners) || 0 %>" min="0">
                      </div>
                      <div class="col-6">
                        <label for="modalAwayCorners" class="form-label">Away Corners</label>
                        <input type="number" class="form-control" id="modalAwayCorners" value="<%= match.stats?.awayCorners || (match.stats?.away && match.stats.away.corners) || 0 %>" min="0">
                      </div>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-6">
                        <label for="modalHomeYellowCards" class="form-label">Home Yellow Cards</label>
                        <input type="number" class="form-control" id="modalHomeYellowCards" value="<%= match.stats?.homeYellowCards || (match.stats?.home && match.stats.home.yellowCards) || 0 %>" min="0">
                      </div>
                      <div class="col-6">
                        <label for="modalAwayYellowCards" class="form-label">Away Yellow Cards</label>
                        <input type="number" class="form-control" id="modalAwayYellowCards" value="<%= match.stats?.awayYellowCards || (match.stats?.away && match.stats.away.yellowCards) || 0 %>" min="0">
                      </div>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-6">
                        <label for="modalHomeRedCards" class="form-label">Home Red Cards</label>
                        <input type="number" class="form-control" id="modalHomeRedCards" value="<%= match.stats?.homeRedCards || (match.stats?.home && match.stats.home.redCards) || 0 %>" min="0">
                      </div>
                      <div class="col-6">
                        <label for="modalAwayRedCards" class="form-label">Away Red Cards</label>
                        <input type="number" class="form-control" id="modalAwayRedCards" value="<%= match.stats?.awayRedCards || (match.stats?.away && match.stats.away.redCards) || 0 %>" min="0">
                      </div>
                    </div>
                  <% } else { %>
                    <div class="row mb-3">
                      <div class="col-6">
                        <label for="modalHomeScore" class="form-label">
                          <%= typeof match.homeTeam === 'object' && match.homeTeam.name ? match.homeTeam.name : (typeof match.homeTeam === 'string' ? match.homeTeam : 'Home Team') %> Score
                        </label>
                        <input type="number" class="form-control" id="modalHomeScore" value="<%= match.homeScore || (match.score && match.score.home) || 0 %>" min="0">
                      </div>
                      <div class="col-6">
                        <label for="modalAwayScore" class="form-label">
                          <%= typeof match.awayTeam === 'object' && match.awayTeam.name ? match.awayTeam.name : (typeof match.awayTeam === 'string' ? match.awayTeam : 'Away Team') %> Score
                        </label>
                        <input type="number" class="form-control" id="modalAwayScore" value="<%= match.awayScore || (match.score && match.score.away) || 0 %>" min="0">
                      </div>
                    </div>
                  <% } %>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveScore">Update Score</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Delete Match Modal -->
        <div class="modal fade" id="deleteMatchModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>Are you sure you want to delete this match between <strong><%= typeof match.homeTeam === 'object' && match.homeTeam.name ? match.homeTeam.name : (typeof match.homeTeam === 'string' ? match.homeTeam : 'Unknown Team') %></strong> and <strong><%= typeof match.awayTeam === 'object' && match.awayTeam.name ? match.awayTeam.name : (typeof match.awayTeam === 'string' ? match.awayTeam : 'Unknown Team') %></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="/admin/matches/delete/<%= match._id %>" method="POST">
                  <button type="submit" class="btn btn-danger">Delete Match</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Show toast function
      function showToast(title, message, isError = false) {
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toast-title');
        const toastMessage = document.getElementById('toast-message');
        
        if (toast && toastTitle && toastMessage) {
          toastTitle.textContent = title;
          toastMessage.textContent = message;
          
          // Remove previous classes
          toast.classList.remove('bg-success', 'bg-danger', 'text-white');
          
          if (isError) {
            toast.classList.add('bg-danger', 'text-white');
          } else {
            toast.classList.add('bg-success', 'text-white');
          }
          
          const bsToast = new bootstrap.Toast(toast);
          bsToast.show();
        }
      }
      
      // Update score functionality
      const saveScoreBtn = document.getElementById('saveScore');
      if (saveScoreBtn) {
        saveScoreBtn.addEventListener('click', function() {
          // Get values based on match category
          let scoreData = {};
          
          // Set scoreData based on category
          const category = '<%= match.category.toLowerCase() %>';
          
          if (category === 'cricket') {
            // Cricket specific fields
            scoreData = {
              homeRuns: document.getElementById('homeRuns').value,
              homeWickets: document.getElementById('homeWickets').value,
              homeOvers: document.getElementById('homeOvers').value,
              homeRunRate: document.getElementById('homeRunRate').value,
              homeExtras: document.getElementById('homeExtras').value,
              homeFours: document.getElementById('homeFours').value,
              homeSixes: document.getElementById('homeSixes').value,
              homeScoreDetail: document.getElementById('homeScoreDetail').value,
              
              awayRuns: document.getElementById('awayRuns').value,
              awayWickets: document.getElementById('awayWickets').value,
              awayOvers: document.getElementById('awayOvers').value,
              awayRunRate: document.getElementById('awayRunRate').value,
              awayExtras: document.getElementById('awayExtras').value,
              awayFours: document.getElementById('awayFours').value,
              awaySixes: document.getElementById('awaySixes').value,
              awayScoreDetail: document.getElementById('awayScoreDetail').value,
              
              // Also include new format (runsScored and nested boundaries)
              'stats.home.runsScored': document.getElementById('homeRuns').value,
              'stats.away.runsScored': document.getElementById('awayRuns').value,
              'stats.home.boundaries.fours': document.getElementById('homeFours').value,
              'stats.home.boundaries.sixes': document.getElementById('homeSixes').value,
              'stats.away.boundaries.fours': document.getElementById('awayFours').value,
              'stats.away.boundaries.sixes': document.getElementById('awaySixes').value,
              
              // Regular format for compatibility
              'stats.home.runs': document.getElementById('homeRuns').value,
              'stats.home.wickets': document.getElementById('homeWickets').value,
              'stats.home.overs': document.getElementById('homeOvers').value,
              'stats.home.runRate': document.getElementById('homeRunRate').value,
              'stats.home.extras': document.getElementById('homeExtras').value,
              'stats.home.fours': document.getElementById('homeFours').value,
              'stats.home.sixes': document.getElementById('homeSixes').value,
              
              'stats.away.runs': document.getElementById('awayRuns').value,
              'stats.away.wickets': document.getElementById('awayWickets').value, 
              'stats.away.overs': document.getElementById('awayOvers').value,
              'stats.away.runRate': document.getElementById('awayRunRate').value,
              'stats.away.extras': document.getElementById('awayExtras').value,
              'stats.away.fours': document.getElementById('awayFours').value,
              'stats.away.sixes': document.getElementById('awaySixes').value,
              
              // Score fields are also nested in score object
              'score.home': document.getElementById('homeRuns').value,
              'score.away': document.getElementById('awayRuns').value,
              'score.home_detail': document.getElementById('homeScoreDetail').value,
              'score.away_detail': document.getElementById('awayScoreDetail').value,
              'score.home_overs': document.getElementById('homeOvers').value,
              'score.away_overs': document.getElementById('awayOvers').value
            };
          } else if (category === 'football') {
            // Football specific fields
            scoreData = {
              homeScore: document.getElementById('modalHomeScore').value,
              awayScore: document.getElementById('modalAwayScore').value,
              
              // Football stats - support both flat and nested formats
              homePossession: document.getElementById('modalHomePossession').value,
              awayPossession: document.getElementById('modalAwayPossession').value,
              homeShots: document.getElementById('modalHomeShots').value,
              awayShots: document.getElementById('modalAwayShots').value,
              homeShotsOnTarget: document.getElementById('modalHomeShotsOnTarget').value,
              awayShotsOnTarget: document.getElementById('modalAwayShotsOnTarget').value,
              homeCorners: document.getElementById('modalHomeCorners').value,
              awayCorners: document.getElementById('modalAwayCorners').value,
              homeYellowCards: document.getElementById('modalHomeYellowCards').value,
              awayYellowCards: document.getElementById('modalAwayYellowCards').value,
              homeRedCards: document.getElementById('modalHomeRedCards').value,
              awayRedCards: document.getElementById('modalAwayRedCards').value,
              
              // Also include nested structure format for compatibility
              'score.home': document.getElementById('modalHomeScore').value,
              'score.away': document.getElementById('modalAwayScore').value,
              'stats.home.possession': document.getElementById('modalHomePossession').value,
              'stats.away.possession': document.getElementById('modalAwayPossession').value,
              'stats.home.shotsTotal': document.getElementById('modalHomeShots').value,
              'stats.away.shotsTotal': document.getElementById('modalAwayShots').value,
              'stats.home.shotsOnTarget': document.getElementById('modalHomeShotsOnTarget').value,
              'stats.away.shotsOnTarget': document.getElementById('modalAwayShotsOnTarget').value,
              'stats.home.corners': document.getElementById('modalHomeCorners').value,
              'stats.away.corners': document.getElementById('modalAwayCorners').value,
              'stats.home.yellowCards': document.getElementById('modalHomeYellowCards').value,
              'stats.away.yellowCards': document.getElementById('modalAwayYellowCards').value,
              'stats.home.redCards': document.getElementById('modalHomeRedCards').value,
              'stats.away.redCards': document.getElementById('modalAwayRedCards').value
            };
          } else {
            // Regular score fields
            scoreData = {
              homeScore: document.getElementById('modalHomeScore').value,
              awayScore: document.getElementById('modalAwayScore').value
            };
          }
          
          fetch(`/admin/matches/score/<%= match._id %>`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(scoreData),
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Close modal
              const modal = bootstrap.Modal.getInstance(document.getElementById('updateScoreModal'));
              modal.hide();
              
              // Show success message
              showToast('Success', 'Score updated successfully');
              
              // Update score in the UI
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              showToast('Error', data.message || 'Failed to update score', true);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'Failed to update score. Please try again.', true);
          });
        });
      }
      
      // Commentary form handling
      const commentaryForm = document.getElementById('commentaryForm');
      if (commentaryForm) {
        commentaryForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const commentText = document.getElementById('commentaryText').value;
          const isImportant = document.getElementById('importantCheck').checked;
          
          fetch(`/admin/matches/commentary/<%= match._id %>`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              text: commentText,
              important: isImportant
            }),
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Clear the form
              commentaryForm.reset();
              
              // Show success message
              showToast('Success', 'Commentary added successfully');
              
              // Reload the page to show the updated commentary
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              showToast('Error', data.message || 'Failed to add commentary', true);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'Failed to add commentary. Please try again.', true);
          });
        });
      }
      
      // Delete commentary buttons
      document.querySelectorAll('.delete-comment').forEach(button => {
        button.addEventListener('click', function() {
          const commentId = this.getAttribute('data-comment-id');
          
          fetch(`/admin/matches/commentary/<%= match._id %>/${commentId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('Success', 'Commentary removed successfully');
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              showToast('Error', data.message || 'Failed to remove commentary', true);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'Failed to remove commentary. Please try again.', true);
          });
        });
      });
      
      // Updates form handling
      const updateForm = document.getElementById('updateForm');
      if (updateForm) {
        updateForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const updateText = document.getElementById('updateText').value;
          const isImportant = document.getElementById('updateImportantCheck').checked;
          
          fetch(`/admin/matches/update/<%= match._id %>`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              text: updateText,
              important: isImportant
            }),
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Clear the form
              updateForm.reset();
              
              // Show success message
              showToast('Success', 'Update added successfully');
              
              // Reload the page to show the updated list
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              showToast('Error', data.message || 'Failed to add update', true);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'Failed to add update. Please try again.', true);
          });
        });
      }
      
      // Delete update buttons
      document.querySelectorAll('.delete-update').forEach(button => {
        button.addEventListener('click', function() {
          const updateId = this.getAttribute('data-update-id');
          
          fetch(`/admin/matches/update/<%= match._id %>/${updateId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('Success', 'Update removed successfully');
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              showToast('Error', data.message || 'Failed to remove update', true);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('Error', 'Failed to remove update. Please try again.', true);
          });
        });
      });
      
      // Check for URL parameters for success/error messages
      const urlParams = new URLSearchParams(window.location.search);
      const successMsg = urlParams.get('success');
      const errorMsg = urlParams.get('error');
      
      if (successMsg) {
        showToast('Success', decodeURIComponent(successMsg));
      } else if (errorMsg) {
        showToast('Error', decodeURIComponent(errorMsg), true);
      }
    });
  </script>
</body>
</html> 